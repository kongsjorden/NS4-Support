---
import Layout from '../layouts/Layout.astro';

const sections = [
  {
    id: 'getting-started',
    title: 'Getting Started',
    content: `
      <h3>System Requirements</h3>
      <ul>
        <li>iPhone or iPad running iOS 17.0 or later</li>
        <li>Compatible stage keyboard with USB MIDI</li>
        <li>USB-C cable (USB-C to USB-B) or USB hub</li>
      </ul>

      <h3>First Launch</h3>
      <ol>
        <li>Download Stage Companion from the App Store</li>
        <li>Open the app and accept the disclaimer</li>
        <li>Connect your iPhone to your keyboard via USB</li>
        <li>The app automatically detects connected MIDI devices</li>
      </ol>
    `,
  },
  {
    id: 'connecting',
    title: 'Connecting Your Keyboard',
    content: `
      <h3>USB Connection (Recommended)</h3>
      <p>For the lowest latency (5-10ms), connect via USB:</p>
      <ol>
        <li>Use a USB-C to USB-B cable (or adapter)</li>
        <li>Connect directly to your keyboard's USB port</li>
        <li>Green indicator shows "MIDI" when connected</li>
      </ol>
      <p>The app automatically reconnects if the cable is disconnected and reconnected (hot-swap). Essential for stage use!</p>

      <h3>Bluetooth MIDI</h3>
      <p>For wireless freedom (15-20ms latency):</p>
      <h4>Supported Adapters</h4>
      <ul>
        <li><strong>CME WIDI Master</strong> / WIDI Uhost</li>
        <li><strong>Yamaha MD-BT01</strong></li>
        <li>Other BLE MIDI adapters that support iOS</li>
      </ul>
      <h4>Pairing a Bluetooth MIDI Device</h4>
      <ol>
        <li>Go to <strong>Settings</strong> in the app</li>
        <li>Under <strong>Bluetooth MIDI</strong>, tap <strong>Pair Bluetooth MIDI Device</strong></li>
        <li>iOS's standard Bluetooth MIDI dialog opens</li>
        <li>Select your device from the list</li>
        <li>Once paired, the device will appear in the MIDI Connection list</li>
      </ol>
      <p>Bluetooth devices show a <strong>BLE</strong> badge (cyan), USB devices show <strong>USB</strong>.</p>

      <h3>Troubleshooting</h3>
      <ul>
        <li><strong>No device found:</strong> Make sure your keyboard is powered on and the cable is properly connected</li>
        <li><strong>Connection drops:</strong> Try a different USB cable or check your Bluetooth adapter's battery</li>
        <li><strong>High latency:</strong> Switch from Bluetooth to USB for time-critical functions like MIDI Clock</li>
      </ul>
    `,
  },
  {
    id: 'setlists',
    title: 'Managing Setlists',
    content: `
      <h3>Creating a Setlist</h3>
      <ol>
        <li>Go to the <strong>Setlists</strong> tab</li>
        <li>Tap <strong>+</strong> in the top right</li>
        <li>Give the setlist a name</li>
        <li>Tap <strong>Create</strong></li>
      </ol>

      <h3>Adding Songs</h3>
      <p>Each song can have:</p>
      <ul>
        <li><strong>Song Name:</strong> (required)</li>
        <li><strong>Program:</strong> Select from your keyboard's programs</li>
        <li><strong>BPM:</strong> Tempo for the metronome</li>
        <li><strong>Key:</strong> Musical key (optional)</li>
        <li><strong>Notes:</strong> Notes displayed in Performance Mode</li>
        <li><strong>Master Click:</strong> Toggle auto-start metronome for this song</li>
      </ul>

      <h3>Organizing Songs</h3>
      <ul>
        <li><strong>Drag and drop</strong> to change order</li>
        <li><strong>Swipe left</strong> to delete a song</li>
        <li><strong>Tap</strong> a song to edit</li>
      </ul>

      <h3>Sharing Setlists</h3>
      <h4>Exporting a Setlist</h4>
      <ol>
        <li>Open the setlist</li>
        <li>Tap the <strong>Share</strong> icon</li>
        <li>Choose <strong>Export as JSON</strong></li>
        <li>Share the file via AirDrop, email, or any file sharing method</li>
      </ol>
      <h4>Importing a Setlist</h4>
      <ol>
        <li>Open a JSON setlist file on your device</li>
        <li>Choose to open it with Stage Companion</li>
        <li>Confirm import</li>
      </ol>
      <p><strong>Note:</strong> Sharing includes song metadata, program references, and secondary MIDI config — but not the actual program sounds (these must exist on the recipient's keyboard).</p>
    `,
  },
  {
    id: 'performance',
    title: 'Performance Mode',
    content: `
      <h3>Using Performance Mode</h3>
      <p>Performance Mode is designed for live use with a full-screen, stage-ready interface.</p>

      <h3>Navigation</h3>
      <ul>
        <li><strong>Next Song:</strong> Tap the right side of the screen or swipe left</li>
        <li><strong>Previous Song:</strong> Tap the left side of the screen or swipe right</li>
        <li><strong>Double-tap:</strong> Quick-jump to the song list</li>
      </ul>

      <h3>What Happens on Song Change</h3>
      <ol>
        <li>Program change sent to your keyboard</li>
        <li>Secondary MIDI sent (if configured)</li>
        <li>Metronome tempo updated</li>
        <li>Master Click starts (if enabled for the song)</li>
        <li>Haptic feedback confirms the change</li>
      </ol>

      <h3>Display Information</h3>
      <ul>
        <li>Current song name and number</li>
        <li>Program name and bank</li>
        <li>BPM and musical key</li>
        <li>Performance notes</li>
        <li>Connection status indicator</li>
      </ul>
    `,
  },
  {
    id: 'midi-controls',
    title: 'MIDI Controls',
    content: `
      <h3>Control Tabs</h3>
      <p>The Controls section has 4 tabs:</p>

      <h4>Quick Tab</h4>
      <ul>
        <li><strong>Section Toggles</strong> — Organ/Piano/Synth on/off (CC 9/33/42)</li>
        <li><strong>Layer Scene</strong> — Switch between Scene I and II (CC 8)</li>
        <li><strong>Morph Pad</strong> — XY-pad for Mod Wheel (CC 1) / Expression (CC 11)</li>
        <li><strong>Rotary Speed</strong> — Leslie slow/fast toggle (CC 108)</li>
        <li><strong>Effect Toggles</strong> — Delay/Reverb on/off (NRPN)</li>
      </ul>

      <h4>Organ Tab</h4>
      <ul>
        <li><strong>Drawbars</strong> — 9-fader control (CC 16-24)</li>
        <li><strong>Rotary</strong> — Leslie slow/fast with on/off toggle (CC 108, NRPN 2:80)</li>
        <li><strong>Percussion</strong> — On/Off, Volume, Decay, Harmonic (CC 25-28)</li>
        <li><strong>Vibrato/Chorus</strong> — Type selector and on/off (CC 31)</li>
      </ul>

      <h4>Synth Tab</h4>
      <ul>
        <li><strong>Touch Filter</strong> — XY-pad for Filter Frequency/Resonance (CC 59-60)</li>
        <li><strong>Filter Envelope</strong> — Frequency/Resonance knobs</li>
        <li><strong>ADSR Editor</strong> — Visual envelope editor with draggable points</li>
        <li><strong>Layer Mixer</strong> — Volume control per layer</li>
      </ul>

      <h4>Effects Tab</h4>
      <ul>
        <li><strong>Delay Toggle</strong> — On/Off (NRPN 2:88)</li>
        <li><strong>Reverb Toggle</strong> — On/Off (NRPN 2:104)</li>
        <li><strong>Morph Pad</strong> — Expression control</li>
        <li><strong>Rotary</strong> — Leslie speed control</li>
      </ul>

      <h3>Morph Pad</h3>
      <p>The XY-pad lets you control two parameters simultaneously:</p>
      <ul>
        <li><strong>X-axis:</strong> Mod Wheel (CC 1) or custom CC</li>
        <li><strong>Y-axis:</strong> Expression (CC 11) or custom CC</li>
      </ul>

      <h4>Tilt Mode</h4>
      <p>Control the Morph Pad by tilting your iPhone — hands-free expressive control during performance!</p>
      <ol>
        <li>Tap the <strong>TILT</strong> button in the Morph Pad header</li>
        <li>Hold your phone in your desired neutral position</li>
        <li>The app auto-calibrates — current orientation becomes center</li>
      </ol>
      <p><strong>Using Tilt Mode:</strong></p>
      <ul>
        <li>Tilt left/right → X-axis (Mod Wheel by default)</li>
        <li>Tilt forward/back → Y-axis (Expression by default)</li>
        <li>±30° tilt gives you full 0-127 MIDI range</li>
        <li>Screen stays awake while Tilt Mode is active</li>
        <li>Adjust sensitivity in Settings (0-100%)</li>
      </ul>

      <h4>Auto-Enable Effects</h4>
      <p>Automatically turn on effects when using Morph Pad with effect-related CCs.</p>
      <ol>
        <li>Tap the gear icon to open Morph Pad settings</li>
        <li>Scroll to "Effect Control" section</li>
        <li>Turn on <strong>Auto-Enable Effects</strong></li>
        <li>Optionally enable <strong>Restore on Release</strong></li>
      </ol>
      <p><strong>How it works:</strong> When you use the Morph Pad with an effect CC (e.g., Delay Mix, Reverb Amount), the app automatically sends the NRPN to turn ON that effect. When you release (if Restore on Release is enabled), the effect turns OFF again.</p>
      <p><strong>Use case:</strong> "Swipe in" reverb during a solo — set Y-axis to Reverb Amount, enable Auto-Enable + Restore on Release. Drag up = reverb turns on and fades in. Release = reverb turns off.</p>
    `,
  },
  {
    id: 'midi-reference',
    title: 'MIDI CC Reference',
    content: `
      <h3>Control Change Messages</h3>
      <table>
        <thead>
          <tr>
            <th>Function</th>
            <th>CC/NRPN</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Mod Wheel</td><td>CC 1</td></tr>
          <tr><td>Volume</td><td>CC 7</td></tr>
          <tr><td>Layer Scene</td><td>CC 8</td></tr>
          <tr><td>Organ On/Off (Scene I)</td><td>CC 9</td></tr>
          <tr><td>Expression</td><td>CC 11</td></tr>
          <tr><td>Drawbars 1-9</td><td>CC 16-24</td></tr>
          <tr><td>Piano On/Off (Scene I)</td><td>CC 33</td></tr>
          <tr><td>Synth On/Off (Scene I)</td><td>CC 42</td></tr>
          <tr><td>Filter Frequency</td><td>CC 59</td></tr>
          <tr><td>Filter Resonance</td><td>CC 60</td></tr>
          <tr><td>Sustain</td><td>CC 64</td></tr>
          <tr><td>Rotary Speed</td><td>CC 108</td></tr>
          <tr><td>Rotary Drive</td><td>CC 110</td></tr>
          <tr><td>Reverb Amount</td><td>CC 113</td></tr>
          <tr><td>Rotary On/Off (Amp/EQ)</td><td>NRPN 2:80</td></tr>
          <tr><td>Mod 1 On/Off</td><td>NRPN 2:64</td></tr>
          <tr><td>Mod 2 On/Off</td><td>NRPN 2:72</td></tr>
          <tr><td>Delay On/Off</td><td>NRPN 2:88</td></tr>
          <tr><td>Reverb On/Off</td><td>NRPN 2:104</td></tr>
        </tbody>
      </table>
      <p><strong>Note:</strong> Rotary On/Off controls the Amp/EQ section. Ensure Rotary is selected as the Amp/EQ type on your keyboard for this to affect the Leslie effect.</p>

      <h3>Program Changes</h3>
      <p>Stage keyboards typically use Bank Select (CC0/CC32) followed by Program Change:</p>
      <ul>
        <li><strong>Banks A, B:</strong> CC0=0, CC32=0</li>
        <li><strong>Banks C, D:</strong> CC0=0, CC32=1</li>
        <li><strong>Banks E, F:</strong> CC0=0, CC32=2</li>
        <li><strong>Banks G, H:</strong> CC0=0, CC32=3</li>
      </ul>
      <p>Program numbers use the format: XX (page 1-8, slot 1-8). Example: A:11 = first program, A:88 = 64th program.</p>

      <h3>Keyboard Shortcuts (iPad)</h3>
      <table>
        <thead>
          <tr>
            <th>Key</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>→</td><td>Next song</td></tr>
          <tr><td>←</td><td>Previous song</td></tr>
          <tr><td>Space</td><td>Start/stop metronome</td></tr>
        </tbody>
      </table>
    `,
  },
];
---

<Layout title="User Guide" description="Complete guide to using Stage Companion with your stage keyboard.">
  <div class="pt-32 pb-20 md:pt-40">
    <div class="max-w-6xl mx-auto px-6">
      <div class="grid lg:grid-cols-[280px,1fr] gap-12">
        <!-- Sidebar Navigation -->
        <aside class="hidden lg:block">
          <div class="sticky top-24">
            <h2 class="font-display font-semibold text-text mb-4">Contents</h2>
            <nav class="space-y-1">
              {sections.map(section => (
                <a
                  href={`#${section.id}`}
                  class="block px-4 py-2 rounded-lg text-text-muted hover:text-text hover:bg-surface transition-colors text-sm"
                >
                  {section.title}
                </a>
              ))}
            </nav>
          </div>
        </aside>

        <!-- Content -->
        <div class="min-w-0">
          <h1 class="font-display font-bold text-4xl md:text-5xl text-text mb-6">
            User Guide
          </h1>
          <p class="text-text-muted text-lg mb-12">
            Everything you need to know to get the most out of Stage Companion.
          </p>

          <!-- Mobile TOC -->
          <div class="lg:hidden mb-12 p-4 bg-surface rounded-xl border border-border">
            <h2 class="font-display font-semibold text-text mb-3">Contents</h2>
            <nav class="space-y-1">
              {sections.map(section => (
                <a
                  href={`#${section.id}`}
                  class="block py-2 text-text-muted hover:text-primary transition-colors text-sm"
                >
                  {section.title}
                </a>
              ))}
            </nav>
          </div>

          <!-- Sections -->
          <div class="space-y-16">
            {sections.map(section => (
              <section id={section.id} class="scroll-mt-24">
                <h2 class="font-display font-bold text-2xl md:text-3xl text-text mb-6 pb-4 border-b border-border">
                  {section.title}
                </h2>
                <div class="prose prose-invert max-w-none" set:html={section.content} />
              </section>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .font-display {
    font-family: 'Outfit', sans-serif;
  }

  /* Prose styling for guide content */
  .prose {
    color: var(--color-text-muted);
  }

  .prose h3 {
    font-family: 'Outfit', sans-serif;
    font-weight: 600;
    font-size: 1.25rem;
    color: var(--color-text);
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .prose h4 {
    font-family: 'Outfit', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    color: var(--color-text);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    margin-bottom: 1rem;
    line-height: 1.7;
  }

  .prose ul, .prose ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  .prose ul li {
    list-style-type: disc;
  }

  .prose ol li {
    list-style-type: decimal;
  }

  .prose strong {
    color: var(--color-text);
    font-weight: 600;
  }

  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }

  .prose th, .prose td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .prose th {
    font-family: 'Outfit', sans-serif;
    font-weight: 600;
    color: var(--color-text);
    background: var(--color-surface);
  }

  .prose td {
    font-family: ui-monospace, monospace;
    font-size: 0.875rem;
  }
</style>
